<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Attendance System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"/>
  <style>
    body {
      background-color: #f6f6f6;
      font-family: 'Playfair Display', serif;
    }
    .appname {
      background-color: #023246;
      color: #f6f6f6;
      padding: 10px 0;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      margin-top: 20px;
    }
    .card {
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .card-body {
      padding: 2rem;
    }
    .form-label {
      font-weight: bold;
    }
    .custom-login-btn {
      background-color: #267094;
      color: white;
      transition: background-color 0.3s ease;
    }
    .custom-login-btn:hover {
      background-color: #1e5d7a;
      color: #ffffff;
    }
    .loading {
      display: none;
    }
    .error-message {
      color: #dc3545;
      font-size: 14px;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<div class="appname">Student Attendance System</div>

<form id="loginForm">
  <div class="container mt-6">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h3 class="text-center mb-4">Login</h3>

            <div class="mb-3">
              <label class="form-label">Teacher</label>
              <input type="radio" name="userType" value="teacher" checked onchange="toggleFields()" />
              <label class="form-label">Student</label>
              <input type="radio" name="userType" value="student" onchange="toggleFields()" />
            </div>

            <div class="mb-3" id="studentIdGroup" style="display: none;">
              <label for="studentid" class="form-label">Student ID</label>
              <input type="text" class="form-control" id="studentid" placeholder="Enter your Student ID" />
            </div>

            <div class="mb-3" id="studentNameGroup" style="display: none;">
              <label for="studentname" class="form-label">Name</label>
              <input type="text" class="form-control" id="studentname" placeholder="Enter your Name" />
            </div>

            <div class="mb-3" id="teacherIdGroup">
              <label for="teacherid" class="form-label">Teacher ID</label>
              <input type="text" class="form-control" id="teacherid" placeholder="Enter your Teacher ID" />
            </div>

            <div class="mb-3" id="classIdGroup">
              <label for="classid" class="form-label">Class</label>
              <select name="classid" class="form-control" id="classid">
                <option value="" disabled selected>-- Select Class --</option>
                <!-- classes dynamically inserted here -->
              </select>
            </div>

            <div class="mb-3" id="passwordGroup">
              <label for="password" class="form-label">Password</label>
              <input type="password" class="form-control" id="password" placeholder="Enter your password" />
            </div>

            <div id="errorMessage" class="error-message"></div>

            <button type="submit" class="btn w-100 custom-login-btn">
              <span class="loading">Logging in...</span>
              <span class="login-text">Login</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>

<script>
// -------- IndexedDB Helper/Simplified (same as admin dashboard) -----
let db;
const DB_NAME = 'attendanceDB', DB_VERSION = 1;

function openDB() {
  return new Promise((resolve, reject) => {
    if (db) return resolve(db);
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = evt => {
      db = evt.target.result;
      ["classes", "students", "teachers", "holidays"].forEach(store =>
        !db.objectStoreNames.contains(store) && db.createObjectStore(store, { keyPath: store === 'holidays' ? 'date' : 'id' }));
      if (!db.objectStoreNames.contains('logs')) db.createObjectStore('logs', { autoIncrement: true });
    };
    req.onsuccess = evt => { db = evt.target.result; resolve(db); };
    req.onerror = evt => reject(evt.target.error);
  });
}
function getAll(store) {
  return openDB().then(() =>
    new Promise((res, rej) => {
      const tx = db.transaction([store], "readonly"), s = tx.objectStore(store), r = s.getAll();
      r.onsuccess = () => res(r.result);
      r.onerror = () => rej(r.error);
    })
  );
}
// ---------------------------------------------------------

// --- UI Helper/State functions ---
function showError(message) {
  const errorDiv = document.getElementById('errorMessage');
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
}
function clearError() {
  const errorDiv = document.getElementById('errorMessage');
  errorDiv.textContent = '';
  errorDiv.style.display = 'none';
}
function setLoading(loading) {
  const loadingSpan = document.querySelector('.loading');
  const loginSpan = document.querySelector('.login-text');
  const submitBtn = document.querySelector('button[type="submit"]');
  if (loading) {
    loadingSpan.style.display = 'inline';
    loginSpan.style.display = 'none';
    submitBtn.disabled = true;
  } else {
    loadingSpan.style.display = 'none';
    loginSpan.style.display = 'inline';
    submitBtn.disabled = false;
  }
}


// --- Load Classes in Class Dropdown, on page load ---
async function populateClassDropdown() {
  await openDB();
  const sel = document.getElementById("classid");
  const classes = await getAll('classes');
  sel.innerHTML = `<option value="" disabled selected>-- Select Class --</option>`;
  classes.forEach(cls => {
    sel.innerHTML += `<option value="${cls.id}">${cls.id}${cls.name ? ` - ${cls.name}` : ''}</option>`;
  });
}
window.onload = populateClassDropdown;

// --- Toggle visible fields by usertype ---
function toggleFields() {
  const userType = document.querySelector('input[name="userType"]:checked').value;
  document.getElementById("teacherIdGroup").style.display = userType === "teacher" ? "block" : "none";
  document.getElementById("passwordGroup").style.display = userType === "teacher" ? "block" : "none";
  document.getElementById("studentIdGroup").style.display = userType === "student" ? "block" : "none";
  document.getElementById("studentNameGroup").style.display = userType === "student" ? "block" : "none";
  clearError();
}
toggleFields();
document.querySelectorAll('input[name="userType"]').forEach(r => r.addEventListener('change', toggleFields));

// ---- Login Handler ----
document.getElementById("loginForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  clearError();
  setLoading(true);

  const userType = document.querySelector('input[name="userType"]:checked').value;
  const classIdValue = document.getElementById("classid").value;

  if (!classIdValue) {
    showError("Please select a class.");
    setLoading(false);
    return;
  }

  try {
    if (userType === "teacher") {
      const teacherId = document.getElementById("teacherid").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!teacherId || !password) {
        showError("Please fill all required fields.");
        setLoading(false);
        return;
      }
      // DIRECT IndexedDB: Lookup for match in teachers
      await openDB();
      const teachers = await getAll("teachers");
      // Your admin stores teacher {id, name, ...}, use "id" and "password":
      const teacher = teachers.find(t =>
        (t.id || t.teacherid) === teacherId && t.password === password
      );
      setLoading(false);

      if (!teacher) {
        showError("Invalid Teacher ID or Password.");
        return;
      }
      // Success - Store data and redirect
      localStorage.setItem("teacherid", teacherId);
      localStorage.setItem("classid", classIdValue);
      localStorage.setItem("userType", "teacher");
      alert("✅ Teacher login successful!");
      window.location.href = `teacherlogin.html?teacherid=${encodeURIComponent(teacherId)}&classid=${encodeURIComponent(classIdValue)}`;

    } else if (userType === "student") {
      const studentId = document.getElementById("studentid").value.trim();
      const studentName = document.getElementById("studentname").value.trim();

      if (!studentId || !studentName) {
        showError("Please enter Student ID and Name.");
        setLoading(false);
        return;
      }
      // DIRECT IndexedDB: Lookup for match in students
      await openDB();
      const students = await getAll("students");
      // Your admin stores student {id, name, classId, contact, gender}
      const student = students.find(s =>
        (s.id || s.studentid) === studentId &&
        s.name === studentName &&
        (s.classId === classIdValue || s.classid === classIdValue)
      );
      setLoading(false);

      if (!student) {
        showError("Student not found or invalid details.");
        return;
      }
      // Success - Store data and redirect
      localStorage.setItem("studentid", studentId);
      localStorage.setItem("classid", classIdValue);
      localStorage.setItem("studentname", studentName);
      localStorage.setItem("userType", "student");
      alert("✅ Student login successful!");
      window.location.href = `studentdashboard.html?classid=${classIdValue}&studentid=${studentId}&name=${encodeURIComponent(studentName)}`;
    }

  } catch (err) {
    setLoading(false);
    console.error("Login error:", err);
    showError("An error occurred during login. Please try again.");
  }
});
</script>

<footer class="text-center mt-5 py-3" style="background-color: #023246; color: #f6f6f6;">
  &copy; 2025 Student Attendance System. All rights reserved.
</footer>
</body>
</html>
