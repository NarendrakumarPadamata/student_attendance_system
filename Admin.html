<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f5f7fa;
      font-family: 'Segoe UI', sans-serif;
    }
    header {
      background-color: #023246;
      color: #fff;
      text-align: center;
      padding: 16px 0;
      font-size: 26px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .card {
      border: none;
      border-radius: 14px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }
    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .dashboard-title {
      font-size: 20px;
      font-weight: bold;
      color: #023246;
      margin-top: 40px;
    }
    .btn-primary {
      background-color: #023246;
      border: none;
    }
    .btn-primary:hover {
      background-color: #03506f;
    }
  </style>
</head>
<body>
  <header>Admin Dashboard â€“ Smart Attendance System</header>
  <div class="container my-4">
    <div class="row g-4 mb-3">
      <div class="col-md-6">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-building"></i> Total Classes</h6>
          <p class="display-6" id="totalClasses">--</p>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-calendar-x"></i> Total Holidays</h6>
          <p class="display-6 text-danger" id="totalHolidays">--</p>
        </div>
      </div>
    </div>

    <h5 class="dashboard-title">Class-wise Summary</h5>
    <div class="row g-4" id="classSummaryContainer"></div>

    <h5 class="dashboard-title mt-4">Class-wise Attendance Summary</h5>
    <div id="classAttendanceSummary" class="mb-4"></div>

    <h5 class="dashboard-title">Admin Operations</h5>
    <div class="row g-4">
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-plus-circle"></i> Manage Classes</h6>
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#classesModal">Open</button>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-person-circle"></i> Manage Students</h6>
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#studentsModal">Open</button>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-person-badge"></i> Manage Teachers</h6>
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#teachersModal">Open</button>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-calendar2-event"></i> Manage Holidays</h6>
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#holidaysModal">Open</button>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-journal-text"></i> View Write Logs</h6>
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#logsModal">Open</button>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-check2-square"></i> Manage Attendance</h6>
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#attendanceModal">Open</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Classes Modal -->
  <div class="modal fade" id="classesModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Manage Classes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul id="classList" class="list-group mb-3"></ul>
          <input type="text" id="newClassInput" class="form-control mb-2" placeholder="New Class ID" />
          <input type="text" id="newClassNameInput" class="form-control mb-2" placeholder="Class Name" />
          <button onclick="addClass()" class="btn btn-success w-100">Add Class</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Students Modal -->
  <div class="modal fade" id="studentsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Manage Students</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 d-flex align-items-center gap-2">
            <label for="studentClassFilter" class="form-label mb-0">Filter by Class:</label>
            <select id="studentClassFilter" class="form-select" style="max-width: 200px;">
              <option value="">All Classes</option>
            </select>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Student ID</th>
                  <th>Name</th>
                  <th>Class ID</th>
                  <th>Contact</th>
                  <th>Gender</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="studentTableBody"></tbody>
            </table>
          </div>
          <h6 class="mt-4">Add New Student</h6>
          <div class="row g-2">
            <div class="col-md-2"><input type="text" id="newStudentID" class="form-control" placeholder="Student ID" /></div>
            <div class="col-md-2"><input type="text" id="newStudentName" class="form-control" placeholder="Name" /></div>
            <div class="col-md-2">
              <select id="newStudentClass" class="form-select">
                <option value="">Select Class</option>
              </select>
            </div>
            <div class="col-md-3"><input type="text" id="newStudentContact" class="form-control" placeholder="Contact" /></div>
            <div class="col-md-2">
              <select id="newStudentGender" class="form-select">
                <option value="">Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-md-1"><button onclick="addStudent()" class="btn btn-success w-100">Add</button></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Teachers Modal -->
  <div class="modal fade" id="teachersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Manage Teachers</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Teacher ID</th>
                  <th>Name</th>
                  <th>Contact</th>
                  <th>Subject</th>
                  <th>Password</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="teacherTableBody"></tbody>
            </table>
          </div>
          <h6 class="mt-4">Add New Teacher</h6>
          <div class="row g-2">
            <div class="col-md-2"><input type="text" id="newTeacherID" class="form-control" placeholder="Teacher ID" required /></div>
            <div class="col-md-3"><input type="text" id="newTeacherName" class="form-control" placeholder="Name" required /></div>
            <div class="col-md-3"><input type="text" id="newTeacherContact" class="form-control" placeholder="Contact" required /></div>
            <div class="col-md-3"><input type="text" id="newTeacherSubject" class="form-control" placeholder="Subject" required /></div>
            <div class="col-md-2"><input type="password" id="newTeacherPassword" class="form-control" placeholder="Password" required /></div>
            <div class="col-md-1"><button onclick="addTeacher()" class="btn btn-success w-100">Add</button></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Holidays Modal -->
  <div class="modal fade" id="holidaysModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Manage Holidays</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="list-group mb-3" id="holidayList"></ul>
          <input type="date" id="newHolidayDate" class="form-control mb-2" placeholder="Holiday Date" />
          <input type="text" id="newHolidayReason" class="form-control mb-2" placeholder="Reason" />
          <button onclick="addHoliday()" class="btn btn-success w-100">Add Holiday</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Logs Modal -->
  <div class="modal fade" id="logsModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Write Logs</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 d-flex gap-2">
            <input type="date" id="logFilterDate" class="form-control" />
            <select id="logTypeFilter" class="form-select" style="max-width:180px;">
              <option value="">All Types</option>
              <option value="Attendance">Attendance</option>
              <option value="Holiday">Holiday</option>
              <option value="Student">Student</option>
              <option value="Teacher">Teacher</option>
              <option value="Class">Class</option>
            </select>
            <select id="logClassFilter" class="form-select" style="max-width:180px;">
              <option value="">All Classes</option>
            </select>
          </div>
          <ul class="list-group" id="logsList"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title">Please Confirm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="confirmModalMsg"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmModalOk">Yes, Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Attendance Modal -->
  <div class="modal fade" id="attendanceModal" tabindex="-1" aria-labelledby="attendanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="attendanceModalLabel">Manage Attendance</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row align-items-center mb-3">
            <div class="col-md-4">
              <label for="attendanceClassFilter" class="form-label">Filter by Class</label>
              <select id="attendanceClassFilter" class="form-select">
                <option value="">Select Class</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="attendanceDateFilter" class="form-label">Date</label>
              <input type="date" id="attendanceDateFilter" class="form-control" />
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button id="loadAttendanceBtn" class="btn btn-primary w-100">Load Attendance</button>
            </div>
          </div>

          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-bordered align-middle text-center">
              <thead class="table-dark">
                <tr>
                  <th>Student ID</th>
                  <th>Name</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="attendanceTableBody">
                <tr><td colspan="3" class="text-center text-muted">Select class and date to load attendance.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button id="saveAttendanceBtn" class="btn btn-success"s>Save Attendance</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Student Modal -->
  <div class="modal fade" id="editStudentModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Student</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editStudentID" />
          <div class="mb-2">
            <label>Name</label>
            <input type="text" id="editStudentName" class="form-control" />
          </div>
          <div class="mb-2">
            <label>Class</label>
            <select id="editStudentClass" class="form-select"></select>
          </div>
          <div class="mb-2">
            <label>Contact</label>
            <input type="text" id="editStudentContact" class="form-control" />
          </div>
          <div class="mb-2">
            <label>Gender</label>
            <select id="editStudentGender" class="form-select">
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" id="saveEditStudentBtn">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Teacher Modal -->
  <div class="modal fade" id="editTeacherModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Teacher</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editTeacherID" />
          <div class="mb-2">
            <label>Name</label>
            <input type="text" id="editTeacherName" class="form-control" />
          </div>
          <div class="mb-2">
            <label>Contact</label>
            <input type="text" id="editTeacherContact" class="form-control" />
          </div>
          <div class="mb-2">
            <label>Subject</label>
            <input type="text" id="editTeacherSubject" class="form-control" />
          </div>
          <div class="mb-2">
            <label>Password</label>
            <input type="password" id="editTeacherPassword" class="form-control" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" id="saveEditTeacherBtn">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // === IndexedDB Setup and Helpers ===
let db;
const DB_NAME = 'attendanceDB', DB_VERSION = 6;
let classes = [];
let students = [];
let teachers = [];
let holidays = [];
let logs = [];
let attendanceRecordsAll = [];

function openDB() {
  return new Promise((resolve, reject) => {
    if (db) return resolve(db);
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = evt => {
      db = evt.target.result;
      const keyPaths = {
        holidays: 'date',
        classes: 'id',
        students: 'id',
        teachers: 'id'
      };
      ['classes', 'students', 'teachers', 'holidays', 'attendance', 'logs'].forEach(store => {
        if (!db.objectStoreNames.contains(store)) {
          if (store === 'attendance' || store === 'logs') {
            db.createObjectStore(store, { autoIncrement: true });
          } else {
            db.createObjectStore(store, { keyPath: keyPaths[store] });
          }
        }
      });
    };
    req.onsuccess = evt => { db = evt.target.result; resolve(db); };
    req.onerror = evt => reject(evt.target.error);
  });
}

function getAll(store) {
  return openDB().then(() =>
    new Promise((resolve, reject) => {
      const tx = db.transaction([store], "readonly"),
            storeObj = tx.objectStore(store),
            request = storeObj.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    })
  );
}

function save(store, val) {
  return openDB().then(() =>
    new Promise((res, rej) => {
      const tx = db.transaction([store], "readwrite"),
            storeObj = tx.objectStore(store),
            request = storeObj.put(val);
      request.onsuccess = () => res(true);
      request.onerror = () => rej(request.error);
    })
  );
}

function remove(store, key) {
  return openDB().then(() =>
    new Promise((res, rej) => {
      const tx = db.transaction([store], "readwrite"),
            storeObj = tx.objectStore(store),
            request = storeObj.delete(key);
      request.onsuccess = () => res(true);
      request.onerror = () => rej(request.error);
    })
  );
}

function formatDate(date) {
  return date.toISOString().slice(0, 10);
}

// --- LOG WRITING FOR ALL ACTIONS ---
async function addLog({ type, message, date = formatDate(new Date()), classId = '', details = {} }) {
  await save('logs', {
    type,
    message,
    date,
    classId,
    ...details
  });
  if (typeof renderLogs === "function") renderLogs();
}

// --- Class-wise Attendance Summary ---
function calculateClassAttendanceSummary(classes, students, attendanceRecordsAll, date) {
  const results = [];
  classes.forEach(cls => {
    const classId = cls.id;
    const studentsInClass = students.filter(s => s.classId === classId || s.classid === classId);
    const totalStudents = studentsInClass.length;
    if (totalStudents === 0) {
      results.push({
        classId,
        totalStudents: 0,
        totalPresent: 0,
        averageAttendancePercentage: null
      });
      return;
    }
    const attendanceForDate = attendanceRecordsAll.filter(r => 
      ((r.classId === classId || r.classid === classId) && r.date === date)
    );

    let presentCount = 0;
    studentsInClass.forEach(student => {
      const adminRec = attendanceForDate.find(r =>
        (r.studentId === student.id || r.studentid === student.id) && r.markedByAdmin === true);
      const teacherRec = attendanceForDate.find(r =>
        (r.studentId === student.id || r.studentid === student.id) && (!r.markedByAdmin || r.markedByAdmin === false));
      const status = adminRec ? adminRec.status : (teacherRec ? teacherRec.status : 'Absent');
      if (status === 'Present') presentCount++;
    });

    const avgAttendancePercent = (presentCount / totalStudents) * 100;

    results.push({
      classId,
      totalStudents,
      totalPresent: presentCount,
      averageAttendancePercentage: Math.round(avgAttendancePercent * 100) / 100
    });
  });
  return results;
}

function renderClassAttendanceSummary(date) {
  const container = document.getElementById('classAttendanceSummary');
  if (!container) return;

  const summary = calculateClassAttendanceSummary(classes, students, attendanceRecordsAll, date);

  if (!summary.length) {
    container.innerHTML = "<p>No classes available</p>";
    return;
  }

  let html = `
  <table class="table table-bordered table-striped align-middle text-center">
    <thead class="table-dark">
      <tr>
        <th>Class ID</th>
        <th>Total Students</th>
        <th>Total Present</th>
        <th>Avg. Attendance (%)</th>
      </tr>
    </thead>
    <tbody>`;

  summary.forEach(row => {
    html += `
      <tr>
        <td>${row.classId}</td>
        <td>${row.totalStudents}</td>
        <td>${row.totalPresent}</td>
        <td>${row.averageAttendancePercentage !== null ? row.averageAttendancePercentage.toFixed(2) : "N/A"}</td>
      </tr>`;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

// --- Render Functions and Management ---

async function loadAllData() {
  [classes, students, teachers, holidays, logs, attendanceRecordsAll] = await Promise.all([
    getAll('classes'),
    getAll('students'),
    getAll('teachers'),
    getAll('holidays'),
    getAll('logs'),
    getAll('attendance')
  ]);
  renderClasses();
  renderStudentTable();
  renderTeacherTable();
  renderHolidays();
  renderLogs();
  populateClassDropdowns();
  renderAttendanceTable();

  const date = document.getElementById('attendanceDateFilter')?.value || formatDate(new Date());
  renderClassAttendanceSummary(date);
}

function renderClasses() {
  const totalEl = document.getElementById("totalClasses");
  if (totalEl) totalEl.textContent = classes.length;

  const container = document.getElementById("classSummaryContainer");
  if (container) {
    container.innerHTML = "";
    classes.forEach(cls => {
      const studentsCount = students.filter(st => st.classId === cls.id).length;
      const classTeacher = teachers.find(
        t => t.subject && cls.name && cls.name.includes(t.subject)
      )?.name || "Not Assigned";
      container.innerHTML += `<div class="col-md-4"><div class="card p-3">
        <h6 class="card-title">Class ID: ${cls.id}${cls.name ? ` <span class="text-secondary">(${cls.name})</span>` : ""}</h6>
        <ul class="list-group list-group-flush">
            <li class="list-group-item">Class Teacher: <strong>${classTeacher}</strong></li>
            <li class="list-group-item">Total Students: <strong>${studentsCount}</strong></li>
        </ul></div></div>`;
    });
  }

  const classList = document.getElementById("classList");
  if (classList) {
    classList.innerHTML = "";
    classes.forEach((cls) => {
      const studentsCount = students.filter(st => st.classId === cls.id).length;
      classList.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
        <div><strong>${cls.id}</strong>${cls.name ? ` - ${cls.name}` : ""}<span class="ms-2 text-muted">Students: ${studentsCount}</span></div>
        <button class="btn btn-sm btn-danger" onclick="deleteClass('${cls.id}')">Delete</button>
      </li>`;
    });
  }
}

function renderStudentTable() {
  const tbody = document.getElementById("studentTableBody");
  if (!tbody) return;
  const filterClass = document.getElementById("studentClassFilter")?.value;
  let filteredStudents = filterClass ? students.filter(s => s.classId === filterClass) : students;
  tbody.innerHTML = "";
  if (!filteredStudents.length) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No students found for this selection.</td></tr>`;
    return;
  }
  filteredStudents.forEach(stu => {
    tbody.innerHTML += `<tr data-id="${stu.id}">
      <td class="editable" data-field="id">${stu.id}</td>
      <td class="editable" data-field="name">${stu.name}</td>
      <td class="editable" data-field="classId">${stu.classId}</td>
      <td class="editable" data-field="contact">${stu.contact || ""}</td>
      <td class="editable" data-field="gender">${stu.gender || ""}</td>
      <td>
        <div class="d-flex gap-1">
          <button class="btn btn-sm btn-primary edit-inline">Edit</button>
          <button class="btn btn-sm btn-success save-inline" style="display:none;">Save</button>
          <button class="btn btn-sm btn-danger delete-inline">Delete</button>
        </div>
      </td>
    </tr>`;
  });

  tbody.querySelectorAll('.edit-inline').forEach(btn => {
    btn.onclick = function() {
      const tr = btn.closest('tr');
      tr.querySelectorAll('.editable').forEach(td => {
        const field = td.getAttribute('data-field');
        let value = td.textContent;
        if (field === "id") {
          td.innerHTML = `<input type="text" class="form-control form-control-sm" value="${value}">`;
        } else if (field === "gender") {
          td.innerHTML = `<select class="form-select form-select-sm">
            <option value="Male"${value==="Male"?" selected":""}>Male</option>
            <option value="Female"${value==="Female"?" selected":""}>Female</option>
            <option value="Other"${value==="Other"?" selected":""}>Other</option>
          </select>`;
        } else if (field === "classId") {
          td.innerHTML = `<select class="form-select form-select-sm">
            ${classes.map(c => `<option value="${c.id}"${value===c.id?" selected":""}>${c.id}</option>`).join('')}
          </select>`;
        } else {
          td.innerHTML = `<input type="text" class="form-control form-control-sm" value="${value}">`;
        }
      });
      tr.querySelector('.save-inline').style.display = '';
      btn.style.display = 'none';
    };
  });

  tbody.querySelectorAll('.save-inline').forEach(btn => {
    btn.onclick = async function() {
      const tr = btn.closest('tr');
      const oldId = tr.getAttribute('data-id');
      const id = tr.querySelector('[data-field="id"] input')?.value || tr.querySelector('[data-field="id"]').textContent;
      const name = tr.querySelector('[data-field="name"] input')?.value || tr.querySelector('[data-field="name"]').textContent;
      const classId = tr.querySelector('[data-field="classId"] select')?.value || tr.querySelector('[data-field="classId"]').textContent;
      const contact = tr.querySelector('[data-field="contact"] input')?.value || tr.querySelector('[data-field="contact"]').textContent;
      const gender = tr.querySelector('[data-field="gender"] select')?.value || tr.querySelector('[data-field="gender"]').textContent;
      if (![id, name, classId, contact, gender].every(Boolean)) return alert("Please fill all fields.");
      if (id !== oldId && students.some(s => s.id === id)) return alert(`Student ID "${id}" already exists.`);
      if (id !== oldId) await remove('students', oldId);
      await save('students', { id, name, classId, contact, gender });
      await addLog({ type: 'Student', message: `Edited student "${name}" (${id}) inline`, classId });
      await loadAllData();
    };
  });

  // Replace deleteStudent inline call with this event listener:
  tbody.querySelectorAll('.delete-inline').forEach(btn => {
    btn.onclick = function() {
      const tr = btn.closest('tr');
      const id = tr.getAttribute('data-id');
      window.deleteStudent(id);
    };
  });
}

function renderTeacherTable() {
  const tbody = document.getElementById("teacherTableBody");
  if (!tbody) return;
  tbody.innerHTML = "";
  if (!teachers.length) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No teachers found.</td></tr>`;
    return;
  }
  teachers.forEach(t => {
    tbody.innerHTML += `<tr>
      <td>${t.id}</td>
      <td>${t.name}</td>
      <td>${t.contact || ""}</td>
      <td>${t.subject || ""}</td>
      <td>********</td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="editTeacher('${t.id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteTeacher('${t.id}')">Delete</button>
      </td>
    </tr>`;
  });
}

function renderHolidays() {
  const totalHolidays = document.getElementById("totalHolidays");
  if (totalHolidays) totalHolidays.textContent = holidays.length;
  const holidayList = document.getElementById("holidayList");
  if (holidayList) {
    holidayList.innerHTML = holidays.map(h =>
      `<li class="list-group-item d-flex justify-content-between align-items-center">
        <span><strong>${h.date}</strong> - ${h.reason}</span>
        <button class="btn btn-sm btn-danger" onclick="deleteHoliday('${h.date}')">Delete</button>
      </li>`).join('');
  }
}

function renderLogs() {
  const logsList = document.getElementById("logsList");
  if (!logsList) return;
  let filtered = logs;
  const filterDate = document.getElementById("logFilterDate")?.value;
  const filterType = document.getElementById("logTypeFilter")?.value;
  const filterClass = document.getElementById("logClassFilter")?.value;
  if (filterDate) filtered = filtered.filter(log => log.date === filterDate);
  if (filterType) filtered = filtered.filter(log => log.type === filterType);
  if (filterClass) filtered = filtered.filter(log => log.message.includes(filterClass));
  if (!filtered.length) {
    logsList.innerHTML = `<li class="list-group-item text-center text-muted">No logs for this selection.</li>`;
    return;
  }
  logsList.innerHTML = filtered.sort((a, b) => new Date(b.date) - new Date(a.date))
    .map(log =>
      `<li class="list-group-item"><span class="badge bg-info me-2">${log.type}</span> [${log.date}] ${log.message}</li>`
    ).join('');
}

// --- Dropdowns ---
function populateClassDropdowns() {
  const studentClassFilter = document.getElementById("studentClassFilter");
  if (studentClassFilter) {
    const val = studentClassFilter.value;
    studentClassFilter.innerHTML = `<option value="">All Classes</option>` +
      classes.map(c => `<option value="${c.id}"${val === c.id ? " selected" : ""}>${c.id} - ${c.name || ""}</option>`).join('');
  }
  const newStudentClass = document.getElementById("newStudentClass");
  if (newStudentClass) {
    newStudentClass.innerHTML = `<option value="">Select Class</option>` +
      classes.map(c => `<option value="${c.id}">${c.id} - ${c.name || ""}</option>`).join('');
  }
  const attendanceClassFilter = document.getElementById('attendanceClassFilter');
  if (attendanceClassFilter) {
    const val = attendanceClassFilter.value;
    attendanceClassFilter.innerHTML = `<option value="">Select Class</option>` +
      classes.map(c => `<option value="${c.id}"${val === c.id ? " selected" : ""}>${c.id} - ${c.name || ""}</option>`).join('');
  }
  const logClassFilter = document.getElementById("logClassFilter");
  if (logClassFilter) {
    const val = logClassFilter.value;
    logClassFilter.innerHTML = `<option value="">All Classes</option>` +
      classes.map(c => `<option value="${c.id}"${val === c.id ? " selected" : ""}>${c.id} - ${c.name || ""}</option>`).join('');
  }
}

// --- Add / Delete Functions === [WITH LOGS] ---
// addStudent already above with log
// addTeacher already above with log
// addClass already above with log
// addHoliday already above with log

// --- Confirmation Modal Helper ---
function confirmAction(message, onConfirm) {
  document.getElementById('confirmModalMsg').textContent = message;
  const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
  modal.show();
  const okBtn = document.getElementById('confirmModalOk');
  okBtn.onclick = () => {
    modal.hide();
    onConfirm();
  };
}

// --- Add / Delete / Edit Functions with Confirmation ---
async function addClass() {
  const id = document.getElementById("newClassInput").value.trim();
  const name = document.getElementById("newClassNameInput").value.trim();
  if (!id || !name) return alert("Please enter both Class ID and Class Name.");
  if (classes.some(cls => cls.id === id)) return alert(`Class ID "${id}" already exists.`);
  confirmAction(`Add class "${name}" (${id})?`, async () => {
    await save('classes', { id, name });
    await addLog({ type: 'Class', message: `Added class "${name}" (${id})`, classId: id });
    document.getElementById("newClassInput").value = "";
    document.getElementById("newClassNameInput").value = "";
    await loadAllData();
  });
}
window.deleteClass = async function(id) {
  confirmAction(`Are you sure you want to delete class ${id}?`, async () => {
    await remove('classes', id);
    await addLog({ type: 'Class', message: `Deleted class "${id}"`, classId: id });
    await loadAllData();
  });
}
async function addStudent() {
  const id = document.getElementById("newStudentID").value.trim();
  const name = document.getElementById("newStudentName").value.trim();
  const classId = document.getElementById("newStudentClass").value;
  const contact = document.getElementById("newStudentContact").value.trim();
  const gender = document.getElementById("newStudentGender").value;
  if (![id, name, classId, contact, gender].every(Boolean)) return alert("Please fill all fields.");
  if (students.some(s => s.id === id)) return alert(`Student ID "${id}" already exists.`);
  if (!classes.some(c => c.id === classId)) return alert(`Class ID "${classId}" is invalid.`);
  confirmAction(`Add student "${name}" (${id}) to class ${classId}?`, async () => {
    await save('students', { id, name, classId, contact, gender });
    await addLog({ type: 'Student', message: `Added student "${name}" (${id}) in Class ${classId}`, classId });
    ["newStudentID", "newStudentName", "newStudentClass", "newStudentContact", "newStudentGender"].forEach(idBox => {
      const el = document.getElementById(idBox); if (el) el.value = "";
    });
    await loadAllData();
  });
}
window.deleteStudent = async function(id) {
  confirmAction(`Are you sure you want to delete student ${id}?`, async () => {
    await remove('students', id);
    await addLog({ type: 'Student', message: `Deleted student ID "${id}"`, classId: "(unknown)" });
    await loadAllData();
  });
}
async function addTeacher() {
  const id = document.getElementById("newTeacherID").value.trim();
  const name = document.getElementById("newTeacherName").value.trim();
  const contact = document.getElementById("newTeacherContact").value.trim();
  const subject = document.getElementById("newTeacherSubject").value.trim();
  const password = document.getElementById("newTeacherPassword").value.trim();
  if (![id, name, contact, subject, password].every(Boolean)) return alert("Please fill all fields.");
  if (teachers.some(t => t.id === id)) return alert(`Teacher ID "${id}" already exists.`);
  confirmAction(`Add teacher "${name}" (${id})?`, async () => {
    await save('teachers', { id, name, contact, subject, password });
    await addLog({ type: 'Teacher', message: `Added teacher "${name}" (${id})`, classId: "(n/a)" });
    ["newTeacherID", "newTeacherName", "newTeacherContact", "newTeacherSubject", "newTeacherPassword"].forEach(fld => {
      const el = document.getElementById(fld); if (el) el.value = "";
    });
    await loadAllData();
  });
}
window.deleteTeacher = async function(id) {
  confirmAction(`Are you sure you want to delete teacher ${id}?`, async () => {
    await remove('teachers', id);
    await addLog({ type: 'Teacher', message: `Deleted teacher ID "${id}"`, classId: "(n/a)" });
    await loadAllData();
  });
}
async function addHoliday() {
  const date = document.getElementById("newHolidayDate").value;
  const reason = document.getElementById("newHolidayReason").value.trim();
  if (!date || !reason) return alert("Please fill both date and reason.");
  if (holidays.some(h => h.date === date)) return alert(`Holiday on "${date}" already exists.`);
  confirmAction(`Add holiday "${reason}" on ${date}?`, async () => {
    await save('holidays', { date, reason });
    await addLog({ type: 'Holiday', message: `Added holiday "${reason}" on ${date}`, date });
    document.getElementById("newHolidayDate").value = "";
    document.getElementById("newHolidayReason").value = "";
    await loadAllData();
  });
}
window.deleteHoliday = async function(date) {
  confirmAction(`Are you sure you want to delete holiday on ${date}?`, async () => {
    await remove('holidays', date);
    await addLog({ type: 'Holiday', message: `Deleted holiday on ${date}`, date });
    await loadAllData();
  });
}

// --- Attendance Table and Management ---
function renderAttendanceTable() {
  const attendanceClassFilter = document.getElementById('attendanceClassFilter');
  const classId = attendanceClassFilter ? attendanceClassFilter.value : "";
  const dateInput = document.getElementById('attendanceDateFilter');
  const date = dateInput ? dateInput.value : "";
  const tbody = document.getElementById('attendanceTableBody');
  if (!tbody || !classId || !date) return;
  const studentsInClass = students.filter(s => s.classId === classId);
  if (!studentsInClass.length) {
    tbody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">No students in this class.</td></tr>`;
    return;
  }
  const attendanceForDate = attendanceRecordsAll.filter(r => r.classId === classId && r.date === date);
  tbody.innerHTML = "";
  studentsInClass.forEach(student => {
    const adminRecord = attendanceForDate.find(r => r.studentId === student.id && r.markedByAdmin === true);
    const teacherRecord = attendanceForDate.find(r => r.studentId === student.id && !r.markedByAdmin);
    const teacherStatus = teacherRecord ? teacherRecord.status : "Not marked";
    const adminStatus = adminRecord ? adminRecord.status : teacherStatus;
    const isToday = (date === formatDate(new Date()));
    const disableSelect = !isToday || !!adminRecord;
    tbody.innerHTML += `<tr>
      <td>${student.id}</td>
      <td>${student.name}</td>
      <td>
        <select class="form-select form-select-sm attendance-status" data-studentid="${student.id}" ${disableSelect ? 'disabled' : ''}>
          <option value="" ${adminStatus === "" ? "selected" : ""}>Select</option>
          <option value="Present" ${adminStatus === "Present" ? "selected" : ""}>Present</option>
          <option value="Absent" ${adminStatus === "Absent" ? "selected" : ""}>Absent</option>
          <option value="Holiday" disabled>Holiday</option>
        </select>
      </td>
    </tr>`;
  });
  // Enable Save button only if it's today's attendance and not admin-marked
  const saveBtn = document.getElementById('saveAttendanceBtn');
  saveBtn.disabled = !document.querySelector('.attendance-status:not([disabled])');
}

// --- Save Attendance --- Add event listener to Save button and implement save logic [ADD LOG!]
document.getElementById('saveAttendanceBtn').addEventListener('click', async () => {
  const attendanceClassFilter = document.getElementById('attendanceClassFilter');
  const classId = attendanceClassFilter ? attendanceClassFilter.value : "";
  const dateInput = document.getElementById('attendanceDateFilter');
  const date = dateInput ? dateInput.value : "";
  if (!classId || !date) return alert("Please select class and date first.");

  const selects = document.querySelectorAll('.attendance-status:not(:disabled)');
  if (!selects.length) return alert("No editable attendance records found.");

  let count = 0;
  for (const select of selects) {
    const studentId = select.getAttribute('data-studentid');
    const status = select.value;
    if (!status) continue;
    const record = {
      classId,
      studentId,
      date,
      status,
      markedByAdmin: true
    };
    await save('attendance', record);
    count++;
  }
  await addLog({ type: 'Attendance', message: `Admin saved attendance for class ${classId} on ${date} (${count} students)`, classId, date });
  alert('Attendance saved successfully.');
  attendanceRecordsAll = await getAll('attendance');
  renderAttendanceTable();
  renderClassAttendanceSummary(date);
  document.getElementById('saveAttendanceBtn').disabled = true;
});

// --- Event Listeners (continued) ---
document.getElementById("studentClassFilter")?.addEventListener("change", renderStudentTable);
document.getElementById("attendanceClassFilter")?.addEventListener("change", renderAttendanceTable);
document.getElementById("attendanceDateFilter")?.addEventListener("change", (e) => {
  renderAttendanceTable();
  const dt = e.target.value || formatDate(new Date());
  renderClassAttendanceSummary(dt);
});
document.getElementById("logFilterDate")?.addEventListener("change", renderLogs);
document.getElementById("logTypeFilter")?.addEventListener("change", renderLogs);
document.getElementById("logClassFilter")?.addEventListener("change", renderLogs);

// Load all data on DOM content loaded
window.addEventListener('DOMContentLoaded', loadAllData);

// --- Placeholder edit functions ---
function editStudent(id) {
  alert(`Edit student functionality for ${id} is not implemented yet.`);
}
function editTeacher(id) {
  alert(`Edit teacher functionality for ${id} is not implemented yet.`);
}

// Helper to populate class dropdown for edit student
function populateEditStudentClassDropdown(selectedId) {
  const select = document.getElementById("editStudentClass");
  if (!select) return;
  select.innerHTML = classes.map(c =>
    `<option value="${c.id}"${c.id === selectedId ? " selected" : ""}>${c.id} - ${c.name || ""}</option>`
  ).join('');
}

// Edit Student Functionality
window.editStudent = function(id) {
  const student = students.find(s => s.id === id);
  if (!student) return alert("Student not found.");
  document.getElementById("editStudentID").value = student.id;
  document.getElementById("editStudentName").value = student.name;
  document.getElementById("editStudentContact").value = student.contact || "";
  document.getElementById("editStudentGender").value = student.gender || "Male";
  populateEditStudentClassDropdown(student.classId);
  const modal = new bootstrap.Modal(document.getElementById("editStudentModal"));
  modal.show();
};

document.getElementById("saveEditStudentBtn").addEventListener("click", async function() {
  const id = document.getElementById("editStudentID").value;
  const name = document.getElementById("editStudentName").value.trim();
  const classId = document.getElementById("editStudentClass").value;
  const contact = document.getElementById("editStudentContact").value.trim();
  const gender = document.getElementById("editStudentGender").value;
  if (![id, name, classId, contact, gender].every(Boolean)) return alert("Please fill all fields.");
  await save('students', { id, name, classId, contact, gender });
  await addLog({ type: 'Student', message: `Edited student "${name}" (${id})`, classId });
  bootstrap.Modal.getInstance(document.getElementById("editStudentModal")).hide();
  await loadAllData();
});

// Edit Teacher Functionality
window.editTeacher = function(id) {
  const teacher = teachers.find(t => t.id === id);
  if (!teacher) return alert("Teacher not found.");
  document.getElementById("editTeacherID").value = teacher.id;
  document.getElementById("editTeacherName").value = teacher.name;
  document.getElementById("editTeacherContact").value = teacher.contact || "";
  document.getElementById("editTeacherSubject").value = teacher.subject || "";
  document.getElementById("editTeacherPassword").value = teacher.password || "";
  const modal = new bootstrap.Modal(document.getElementById("editTeacherModal"));
  modal.show();
};

document.getElementById("saveEditTeacherBtn").addEventListener("click", async function() {
  const id = document.getElementById("editTeacherID").value;
  const name = document.getElementById("editTeacherName").value.trim();
  const contact = document.getElementById("editTeacherContact").value.trim();
  const subject = document.getElementById("editTeacherSubject").value.trim();
  const password = document.getElementById("editTeacherPassword").value.trim();
  if (![id, name, contact, subject, password].every(Boolean)) return alert("Please fill all fields.");
  await save('teachers', { id, name, contact, subject, password });
  await addLog({ type: 'Teacher', message: `Edited teacher "${name}" (${id})`, classId: "(n/a)" });
  bootstrap.Modal.getInstance(document.getElementById("editTeacherModal")).hide();
  await loadAllData();
});

  </script>
</body>
</html>
