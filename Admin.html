<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    body {
      background-color: #f5f7fa;
      font-family: 'Segoe UI', sans-serif;
    }
    header {
      background-color: #023246;
      color: #fff;
      text-align: center;
      padding: 16px 0;
      font-size: 26px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .card {
      border: none;
      border-radius: 14px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }
    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .dashboard-title {
      font-size: 20px;
      font-weight: bold;
      color: #023246;
      margin-top: 40px;
    }
    .btn-primary {
      background-color: #023246;
      border: none;
    }
    .btn-primary:hover {
      background-color: #03506f;
    }
  </style>
</head>
<body>
  <header>Admin Dashboard – Smart Attendance System</header>
  <div class="container my-4">
    <div class="row g-4 mb-3">
      <div class="col-md-6">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-building"></i> Total Classes</h6>
          <p class="display-6" id="totalClasses">--</p>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-calendar-x"></i> Total Holidays</h6>
          <p class="display-6 text-danger" id="totalHolidays">--</p>
        </div>
      </div>
    </div>
    <h5 class="dashboard-title">Class-wise Summary</h5>
    <div class="row g-4" id="classSummaryContainer"></div>
    <h5 class="dashboard-title">Admin Operations</h5>
    <div class="row g-4">
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-plus-circle"></i> Manage Classes</h6>
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#classesModal">Open</button>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-person-circle"></i> Manage Students</h6>
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#studentsModal">Open</button>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-person-badge"></i> Manage Teachers</h6>
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#teachersModal">Open</button>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-calendar2-event"></i> Manage Holidays</h6>
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#holidaysModal">Open</button>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-journal-text"></i> View Write Logs</h6>
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#logsModal">Open</button>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <h6 class="card-title"><i class="bi bi-check2-square"></i> Manage Attendance</h6>
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#attendanceModal">Open</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Classes Modal -->
  <div class="modal fade" id="classesModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Manage Classes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul id="classList" class="list-group mb-3"></ul>
          <input type="text" id="newClassInput" class="form-control mb-2" placeholder="New Class ID"/>
          <input type="text" id="newClassNameInput" class="form-control mb-2" placeholder="Class Name"/>
          <button onclick="addClass()" class="btn btn-success w-100">Add Class</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Students Modal -->
  <div class="modal fade" id="studentsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Manage Students</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 d-flex align-items-center gap-2">
            <label for="studentClassFilter" class="form-label mb-0">Filter by Class:</label>
            <select id="studentClassFilter" class="form-select" style="max-width: 200px;">
              <option value="">All Classes</option>
            </select>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Student ID</th>
                  <th>Name</th>
                  <th>Class ID</th>
                  <th>Contact</th>
                  <th>Gender</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="studentTableBody"></tbody>
            </table>
          </div>
          <h6 class="mt-4">Add New Student</h6>
          <div class="row g-2">
            <div class="col-md-2"><input type="text" id="newStudentID" class="form-control" placeholder="Student ID" /></div>
            <div class="col-md-2"><input type="text" id="newStudentName" class="form-control" placeholder="Name" /></div>
            <div class="col-md-2">
              <select id="newStudentClass" class="form-select">
                <option value="">Select Class</option>
              </select>
            </div>
            <div class="col-md-3"><input type="text" id="newStudentContact" class="form-control" placeholder="Contact" /></div>
            <div class="col-md-2">
              <select id="newStudentGender" class="form-select">
                <option value="">Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-md-1"><button onclick="addStudent()" class="btn btn-success w-100">Add</button></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Teachers Modal -->
  <div class="modal fade" id="teachersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Manage Teachers</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Teacher ID</th>
                  <th>Name</th>
                  <th>Contact</th>
                  <th>Subject</th>
                  <th>Password</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="teacherTableBody"></tbody>
            </table>
          </div>
          <h6 class="mt-4">Add New Teacher</h6>
          <div class="row g-2">
            <div class="col-md-2"><input type="text" id="newTeacherID" class="form-control" placeholder="Teacher ID"  required/></div>
            <div class="col-md-3"><input type="text" id="newTeacherName" class="form-control" placeholder="Name" required/></div>
            <div class="col-md-3"><input type="text" id="newTeacherContact" class="form-control" placeholder="Contact" required/></div>
            <div class="col-md-3"><input type="text" id="newTeacherSubject" class="form-control" placeholder="Subject" required/></div>
            <div class="col-md-2"><input type="password" id="newTeacherPassword" class="form-control" placeholder="Password" required/></div>
            <div class="col-md-1"><button onclick="addTeacher()" class="btn btn-success w-100">Add</button></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Holidays Modal -->
  <div class="modal fade" id="holidaysModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Manage Holidays</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="list-group mb-3" id="holidayList"></ul>
          <input type="date" id="newHolidayDate" class="form-control mb-2" placeholder="Holiday Date"/>
          <input type="text" id="newHolidayReason" class="form-control mb-2" placeholder="Reason"/>
          <button onclick="addHoliday()" class="btn btn-success w-100">Add Holiday</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Logs Modal -->
  <div class="modal fade" id="logsModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Write Logs</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 d-flex gap-2">
            <input type="date" id="logFilterDate" class="form-control" />
            <select id="logTypeFilter" class="form-select" style="max-width:180px;">
              <option value="">All Types</option>
              <option value="Attendance">Attendance</option>
              <option value="Holiday">Holiday</option>
              <option value="Student">Student</option>
              <option value="Teacher">Teacher</option>
              <option value="Class">Class</option>
            </select>
            <select id="logClassFilter" class="form-select" style="max-width:180px;">
              <option value="">All Classes</option>
            </select>
          </div>
          <ul class="list-group" id="logsList"></ul>
        </div>
      </div>
    </div>
  </div>
  <!-- Confirm Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title">Please Confirm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="confirmModalMsg"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmModalOk">Yes, Confirm</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Manage Attendance Modal -->
<div class="modal fade" id="attendanceModal" tabindex="-1" aria-labelledby="attendanceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="attendanceModalLabel">Manage Attendance</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row align-items-center mb-3">
          <div class="col-md-4">
            <label for="attendanceClassFilter" class="form-label">Filter by Class</label>
            <select id="attendanceClassFilter" class="form-select">
              <option value="">Select Class</option>
              <!-- Will be populated dynamically -->
            </select>
          </div>
          <div class="col-md-4">
            <label for="attendanceDateFilter" class="form-label">Date</label>
            <input type="date" id="attendanceDateFilter" class="form-control"/>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button id="loadAttendanceBtn" class="btn btn-primary w-100">Load Attendance</button>
          </div>
        </div>

        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-bordered align-middle text-center">
            <thead class="table-dark">
              <tr>
                <th>Student ID</th>
                <th>Name</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="attendanceTableBody">
              <tr><td colspan="3" class="text-center text-muted">Select class and date to load attendance.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button id="saveAttendanceBtn" class="btn btn-success" disabled>Save Attendance</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // === IndexedDB Setup and Helpers ===
  let db;
  const DB_NAME = 'attendanceDB', DB_VERSION = 6;
  let classes = [];
  let students = [];
  let teachers = [];
  let holidays = [];
  let logs = [];
  let attendanceRecordsAll = [];

  function openDB() {
    return new Promise((resolve, reject) => {
      if (db) return resolve(db);
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = evt => {
        db = evt.target.result;
        ['classes', 'students', 'teachers', 'holidays', 'attendance', 'logs'].forEach(store => {
          if (!db.objectStoreNames.contains(store)) {
            db.createObjectStore(store, {
              keyPath: store === 'holidays' ? 'date' : 'id',
              autoIncrement: store === 'attendance' || store === 'logs'
            });
          }
        });
      };
      req.onsuccess = evt => { db = evt.target.result; resolve(db); };
      req.onerror = evt => reject(evt.target.error);
    });
  }

  function getAll(store) {
    return openDB().then(() =>
      new Promise((resolve, reject) => {
        const tx = db.transaction([store], "readonly"),
              storeObj = tx.objectStore(store),
              request = storeObj.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      })
    );
  }

  function save(store, val) {
    return openDB().then(() =>
      new Promise((res, rej) => {
        const tx = db.transaction([store], "readwrite"),
              storeObj = tx.objectStore(store),
              request = storeObj.put(val);
        request.onsuccess = () => res(true);
        request.onerror = () => rej(request.error);
      })
    );
  }

  function remove(store, key) {
    return openDB().then(() =>
      new Promise((res, rej) => {
        const tx = db.transaction([store], "readwrite"),
              storeObj = tx.objectStore(store),
              request = storeObj.delete(key);
        request.onsuccess = () => res(true);
        request.onerror = () => rej(request.error);
      })
    );
  }

  // --- Utility ---
  function formatDate(date) {
    return date.toISOString().slice(0, 10);
  }

  // --- Main Dashboard Renders ---
  function renderClasses() {
    document.getElementById("totalClasses").textContent = classes.length;
    // Class summary cards:
    const classSummary = document.getElementById("classSummaryContainer");
    if (!classSummary) return;
    classSummary.innerHTML = "";
    classes.forEach((cls, i) => {
      const studentsCount = students.filter(st => st.classId === cls.id).length;
      if (!cls.avgAttendance) cls.avgAttendance = 95;
      const classTeacher = teachers.find(t => t.subject && cls.name && cls.name.includes(t.subject))?.name || "Not Assigned";
      classSummary.innerHTML += `<div class="col-md-4"><div class="card p-3">
          <h6 class="card-title">Class ID: ${cls.id}${cls.name ? ` <span class="text-secondary">(${cls.name})</span>` : ""}</h6>
          <ul class="list-group list-group-flush">
              <li class="list-group-item">Class Teacher: <strong>${classTeacher}</strong></li>
              <li class="list-group-item">Total Students: <strong>${studentsCount}</strong></li>
              <li class="list-group-item">Average Attendance: <strong class="${cls.avgAttendance < 75 ? 'text-danger' : 'text-success'}">${cls.avgAttendance || 0}%</strong></li>
          </ul></div></div>`;
    });
  }
  function renderHolidays() {
    document.getElementById("totalHolidays").textContent = holidays.length;
  }

  // --- CRUD Renders (you can expand as needed) ---
  function populateAttendanceClassFilter() {
    const sel = document.getElementById('attendanceClassFilter');
    if (!sel) return;
    sel.innerHTML = `<option value="">Select Class</option>` +
      classes.map(c => `<option value="${c.id}">${c.id} - ${c.name || ''}</option>`).join('');
  }

  // --- Load All and Render Dashboard ---
  async function loadAllData() {
    [classes, students, teachers, holidays, logs, attendanceRecordsAll] = await Promise.all([
      getAll('classes'),
      getAll('students'),
      getAll('teachers'),
      getAll('holidays'),
      getAll('logs'),
      getAll('attendance')
    ]);
    renderClasses();
    renderHolidays();
    populateAttendanceClassFilter();
    // If modals/tables, call their render too if you want to live-update them
  }

  // --- Manage Attendance modal logic (unchanged except for data reloads reflecting everywhere) ---
  function isHoliday(dateStr) {
    return holidays.some(h => h.date === dateStr);
  }

  function renderAttendanceTable(classId, date) {
    const tbody = document.getElementById('attendanceTableBody');
    tbody.innerHTML = '';

    if (!classId || !date) {
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Please select a class and date.</td></tr>`;
      disableSaveButton(true);
      return;
    }
    if (isHoliday(date)) {
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger fw-bold">Cannot mark attendance on a holiday (${date}).</td></tr>`;
      disableSaveButton(true);
      return;
    }
    const filteredStudents = students.filter(s => s.classId === classId);
    if (filteredStudents.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No students in this class.</td></tr>`;
      disableSaveButton(true);
      return;
    }
    const attendanceForDate = attendanceRecordsAll.filter(r => r.classId === classId && r.date === date);
    filteredStudents.forEach(student => {
      const adminRecord = attendanceForDate.find(r => r.studentId === student.id && r.markedByAdmin === true);
      const teacherRecord = attendanceForDate.find(r => r.studentId === student.id && !r.markedByAdmin);
      const teacherStatus = teacherRecord ? teacherRecord.status : "Not marked";
      const adminStatus = adminRecord ? adminRecord.status : teacherStatus;
      const isToday = (date === formatDate(new Date()));
      const disableSelect = !isToday || !!adminRecord;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${student.id}</td>
        <td>${student.name}</td>
        <td>${teacherStatus}</td>
        <td>
          <select class="form-select form-select-sm attendance-status" data-studentid="${student.id}" ${disableSelect ? 'disabled' : ''}>
            <option value="" ${adminStatus === "" ? "selected" : ""}>Select</option>
            <option value="Present" ${adminStatus === "Present" ? "selected" : ""}>Present</option>
            <option value="Absent" ${adminStatus === "Absent" ? "selected" : ""}>Absent</option>
            <option value="Holiday" disabled>Holiday</option>
          </select>
        </td>`;
      tbody.appendChild(tr);
    });
    disableSaveButton(true);
    const anyEditable = Array.from(tbody.querySelectorAll('select.attendance-status')).some(sel => !sel.disabled);
    if (anyEditable) disableSaveButton(false);
    tbody.querySelectorAll('select.attendance-status').forEach(select => {
      if (!select.disabled) {
        select.addEventListener('change', () => disableSaveButton(false));
      }
    });
  }

  function disableSaveButton(disable) {
    const btn = document.getElementById('saveAttendanceBtn');
    if (btn) btn.disabled = disable;
  }

  // --- Event Handlers ---
  document.getElementById('loadAttendanceBtn').addEventListener('click', () => {
    const classId = document.getElementById('attendanceClassFilter').value;
    const date = document.getElementById('attendanceDateFilter').value;
    if (!classId) return alert('Please select a class.');
    if (!date) return alert('Please select a date.');
    renderAttendanceTable(classId, date);
  });

  // Save Attendance (as admin, only once per student per today)
  document.getElementById('saveAttendanceBtn').addEventListener('click', async () => {
    const classId = document.getElementById('attendanceClassFilter').value;
    const date = document.getElementById('attendanceDateFilter').value;
    if (!classId || !date) {
      alert('Please select class and date before saving attendance.');
      return;
    }
    if (isHoliday(date)) {
      alert('Cannot save attendance on a holiday.');
      return;
    }
    if (date !== formatDate(new Date())) {
      alert('You can only change attendance for today.');
      return;
    }
    const tbody = document.getElementById('attendanceTableBody');
    const selects = tbody.querySelectorAll('select.attendance-status');
    const updates = [];
    selects.forEach(select => {
      const studentId = select.getAttribute('data-studentid');
      const status = select.value;
      if (!status) return;
      let record = attendanceRecordsAll.find(r =>
        r.classId === classId &&
        r.studentId === studentId &&
        r.date === date &&
        r.markedByAdmin === true
      );
      if (record) { // never happens for enabled select as per UI, but handle just in case
        record.status = status;
        updates.push(record);
      } else {
        record = {
          classId,
          studentId,
          date,
          status,
          markedByAdmin: true
        };
        updates.push(record);
      }
    });
    try {
      for (const rec of updates) {
        await save('attendance', rec);
      }
      alert('Attendance saved successfully.');
      await loadAllData();
      renderAttendanceTable(classId, date);
      disableSaveButton(true);
      await save('logs', {
        date: new Date().toISOString(),
        type: 'Attendance',
        message: `Admin updated attendance for class ${classId} on ${date}`
      });
    } catch (error) {
      console.error('Failed to save attendance:', error);
      alert('Failed to save attendance. Please try again.');
    }
  });

  // --- Initialize page loads & dashboard UI ---
  window.addEventListener('DOMContentLoaded', async () => {
    await loadAllData();
    // Set default date to today for manage attendance modal
    const dateInput = document.getElementById('attendanceDateFilter');
    if (dateInput) dateInput.value = formatDate(new Date());
  });

  // If you want to re-load dashboard after CRUD events elsewhere, call loadAllData() again!
</script>



</body>
</html>
